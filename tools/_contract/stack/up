#!/usr/bin/env bash
# Contract: up - Start full development environment with DevContainer
# Uses docker-compose.worktree.yml for web + api + db with Traefik routing
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../.." && pwd)"
cd "${REPO_ROOT}"

# Determine worktree name: "main" for root repo, directory name for worktrees
get_worktree_name() {
    if [[ -f "${REPO_ROOT}/.git" ]]; then
        # .git ãŒãƒ•ã‚¡ã‚¤ãƒ« â†’ worktree
        basename "${REPO_ROOT}"
    else
        # .git ãŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª â†’ ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª
        echo "main"
    fi
}

# Load existing .env or create new one
if [[ -f .env ]]; then
    # shellcheck source=/dev/null
    source .env
fi

# Always use directory name as worktree identifier
WORKTREE="$(get_worktree_name)"
COMPOSE_PROJECT_NAME="${WORKTREE}"
REPO_NAME="$(basename "${REPO_ROOT}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')"

# Update .env with current values
cat > .env << EOF
WORKTREE=${WORKTREE}
REPO_NAME=${REPO_NAME}
COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
HOST_WORKSPACE_PATH=${REPO_ROOT}
EOF

export WORKTREE
export COMPOSE_PROJECT_NAME
export REPO_NAME

echo "ğŸš€ Starting development environment with DevContainer..."
echo "   Worktree: ${WORKTREE}"
echo ""

# Check if docker compose (V2) is available
if docker compose version &>/dev/null; then
  COMPOSE_CMD="docker compose"
else
  COMPOSE_CMD="docker-compose"
fi

# Check for compose file
if [[ ! -f "docker-compose.worktree.yml" ]]; then
  echo "ERROR: docker-compose.worktree.yml not found"
  exit 1
fi

# Ensure traefik network exists
if ! docker network inspect traefik-public &>/dev/null; then
  echo "ğŸ“¡ Creating traefik-public network..."
  docker network create traefik-public
fi

# Build and start all services (includes DevContainer 'dev' service)
echo "ğŸ”¨ Building and starting services..."
${COMPOSE_CMD} -f docker-compose.worktree.yml up --build -d

# Wait for dev container to be healthy (dependencies installed)
echo "â³ Waiting for DevContainer to install dependencies..."
DEV_CONTAINER="${WORKTREE}-${REPO_NAME}-dev"
for i in {1..120}; do
  STATUS=$(docker inspect --format='{{.State.Health.Status}}' "${DEV_CONTAINER}" 2>/dev/null || echo "unknown")
  if [[ "${STATUS}" == "healthy" ]]; then
    echo "âœ… Dependencies installed successfully"
    break
  fi
  if [[ $i -eq 120 ]]; then
    echo "âš ï¸  Timeout waiting for dependencies. Check logs with: ./tools/contract up:logs dev"
  fi
  sleep 2
done

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… Development environment started!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“ Access Points:"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Frontend    â”‚ http://fe.${WORKTREE}.localhost              â”‚"
echo "â”‚ API         â”‚ http://be.${WORKTREE}.localhost              â”‚"
echo "â”‚ Database    â”‚ postgresql://postgres:postgres@localhost:5432/app â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo "ğŸ³ DevContainer:"
echo "   Container: ${DEV_CONTAINER}"
echo "   Attach:    docker exec -it ${DEV_CONTAINER} bash"
echo ""
echo "ğŸ› ï¸  Commands:"
echo "   ./tools/contract up:logs    - View logs"
echo "   ./tools/contract up:logs web - View frontend logs"
echo "   ./tools/contract up:logs api - View API logs"
echo "   ./tools/contract up:stop    - Stop environment"
echo "   ./tools/contract up:status  - Show container status"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
