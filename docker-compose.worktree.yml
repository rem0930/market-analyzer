services:
  db:
    image: postgres:16-alpine
    container_name: ${WORKTREE}-${REPO_NAME}-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=app
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  dev:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile.dev
    container_name: ${WORKTREE}-${REPO_NAME}-dev
    volumes:
      - .:/workspace:cached
      - pnpm-store:/home/node/.local/share/pnpm
    working_dir: /workspace/projects
    tty: true
    stdin_open: true
    networks:
      - internal
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/app
    command: sh -c "pnpm install && touch /workspace/.dev-ready && sleep infinity"
    healthcheck:
      test: ["CMD", "test", "-f", "/workspace/.dev-ready"]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 120s
    depends_on:
      db:
        condition: service_healthy

  web:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile.dev
    container_name: ${WORKTREE}-${REPO_NAME}-web
    volumes:
      - .:/workspace:cached
      - pnpm-store:/home/node/.local/share/pnpm
    working_dir: /workspace/projects/apps/web
    command: sh -c "pnpm next dev --hostname 0.0.0.0 --port 3000"
    environment:
      - NODE_ENV=development
    networks:
      - internal
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${WORKTREE}-web.rule=Host(`${WORKTREE}.${REPO_NAME}.localhost`)"
      - "traefik.http.routers.${WORKTREE}-web.entrypoints=web"
      - "traefik.http.routers.${WORKTREE}-web.priority=1"
      - "traefik.http.services.${WORKTREE}-web.loadbalancer.server.port=3000"
    depends_on:
      dev:
        condition: service_healthy

  api:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile.dev
    container_name: ${WORKTREE}-${REPO_NAME}-api
    volumes:
      - .:/workspace:cached
      - pnpm-store:/home/node/.local/share/pnpm
    working_dir: /workspace/projects
    command: sh -c "pnpm --filter @monorepo/shared build && if [ ! -f /workspace/.db-initialized ]; then pnpm --filter @monorepo/api db:generate && pnpm --filter @monorepo/api db:push && pnpm --filter @monorepo/api db:seed && touch /workspace/.db-initialized; else echo 'Database already initialized, skipping'; fi && pnpm --filter @monorepo/api dev"
    environment:
      - NODE_ENV=development
      - PORT=8080
      - CORS_ALLOWED_ORIGINS=http://${WORKTREE}.${REPO_NAME}.localhost,http://localhost:3000
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/app
      - LOG_FILE_ENABLED=true
      - LOG_DIR=/workspace/logs/api
      - LOG_LEVEL=debug
    networks:
      - internal
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${WORKTREE}-api.rule=Host(`${WORKTREE}.${REPO_NAME}.localhost`) && PathPrefix(`/api`)"
      - "traefik.http.routers.${WORKTREE}-api.entrypoints=web"
      - "traefik.http.routers.${WORKTREE}-api.priority=100"
      - "traefik.http.routers.${WORKTREE}-api.middlewares=${WORKTREE}-strip-api"
      - "traefik.http.middlewares.${WORKTREE}-strip-api.stripprefix.prefixes=/api"
      - "traefik.http.services.${WORKTREE}-api.loadbalancer.server.port=8080"
    depends_on:
      dev:
        condition: service_healthy

volumes:
  pnpm-store:
  db-data:

networks:
  internal:
    driver: bridge
  traefik-public:
    external: true
