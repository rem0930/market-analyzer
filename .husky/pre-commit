#!/bin/sh

# Secrets detection in staged files
# Patterns to detect common secrets and credentials

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND_SECRETS=0

for FILE in $STAGED_FILES; do
  # Skip binary files and common non-secret files
  case "$FILE" in
    *.png|*.jpg|*.jpeg|*.gif|*.ico|*.woff|*.woff2|*.ttf|*.eot|*.svg|*.lock|*.lockb)
      continue
      ;;
  esac

  # Skip example/template files
  case "$FILE" in
    *.example|*.template)
      continue
      ;;
  esac

  if [ -f "$FILE" ]; then
    DIFF_CONTENT=$(git diff --cached "$FILE")

    # AWS Access Key ID
    if echo "$DIFF_CONTENT" | grep -qE 'AKIA[0-9A-Z]{16}'; then
      echo "ERROR: Potential AWS Access Key detected in $FILE"
      FOUND_SECRETS=1
    fi

    # GitHub tokens
    if echo "$DIFF_CONTENT" | grep -qE 'gh[pousr]_[a-zA-Z0-9]{36}'; then
      echo "ERROR: Potential GitHub token detected in $FILE"
      FOUND_SECRETS=1
    fi

    # Private keys (check for actual PEM header with dashes)
    if echo "$DIFF_CONTENT" | grep -qE '^[\+]-----BEGIN .* PRIVATE KEY-----'; then
      echo "ERROR: Potential private key detected in $FILE"
      FOUND_SECRETS=1
    fi

    # JWT tokens
    if echo "$DIFF_CONTENT" | grep -qE 'eyJ[a-zA-Z0-9_-]+\.eyJ[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+'; then
      echo "ERROR: Potential JWT token detected in $FILE"
      FOUND_SECRETS=1
    fi
  fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "Commit blocked: Potential secrets detected in staged files."
  echo "If this is a false positive, you can:"
  echo "  1. Add the file to .gitignore"
  echo "  2. Use 'git commit --no-verify' (not recommended)"
  echo ""
  exit 1
fi

# Auto-regenerate OpenAPI types if openapi.yaml is staged
STAGED_OPENAPI=$(git diff --cached --name-only --diff-filter=ACM | grep 'openapi\.yaml$' || true)
if [ -n "$STAGED_OPENAPI" ]; then
  echo "OpenAPI spec changed â€” regenerating types..."
  if [ -f "projects/packages/api-contract/openapi.yaml" ]; then
    if command -v pnpm >/dev/null 2>&1; then
      pnpm --filter @monorepo/api-contract run generate 2>/dev/null || true
      git add projects/packages/api-contract/src/generated/ 2>/dev/null || true
    fi
  fi
fi

# Run lint-staged for code quality (only if npx is available and in projects directory context)
if command -v npx >/dev/null 2>&1 && [ -d "projects" ] && [ -f "projects/package.json" ]; then
  cd projects && npx --yes lint-staged
fi

exit 0
