name: CI
on:
  pull_request:
  push:
    branches: ["main"]

# Minimum permissions for security
permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================
  # SECURITY GATES (P0 - Must pass before any code runs)
  # ============================================================
  secrets-scan:
    name: Secrets Scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION="8.21.2"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar xz
          chmod +x gitleaks

      - name: Run gitleaks
        run: ./gitleaks detect --source . --verbose --exit-code 1

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: projects
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: projects/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit dependencies
        run: pnpm audit --audit-level=high
        continue-on-error: false

  # ============================================================
  # QUALITY GATES
  # ============================================================
  policy:
    name: Policy Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check required artifacts
        run: |
          chmod +x tools/policy/check_required_artifacts.sh
          bash tools/policy/check_required_artifacts.sh

  lint-and-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: projects
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: projects/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @monorepo/api db:generate

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

  openapi-check:
    name: OpenAPI Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: projects
    steps:
      - uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'pnpm'
          cache-dependency-path: projects/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check OpenAPI generated files are up to date
        run: pnpm openapi:check

  contract:
    name: Contract Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Run contract smoke tests
        run: |
          if [ -f .repo/active-stack ]; then
            stack_id=$(cat .repo/active-stack | tr -d '[:space:]')
            if [[ -n "${stack_id}" && "${stack_id}" != "# Stack"* ]]; then
              chmod +x tools/contract
              ./tools/contract lint || exit 1
              ./tools/contract test || exit 1
              ./tools/contract build || exit 1
            else
              echo "No active stack configured; skipping contract smoke."
            fi
          else
            echo "No active stack file; skipping contract smoke."
          fi
