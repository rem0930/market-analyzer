openapi: 3.0.3
info:
  title: Competitors API
  description: |
    自店舗に紐づく競合店舗を管理する Competitors API。
    手動登録と Google Places API 自動検索の 2 経路を source フィールドで区別する。
    アクセス制御は userId → storeId → competitorId の 2 段階で実施。
  version: 1.0.0

servers:
  - url: http://localhost:3001
    description: Local development server

security:
  - bearerAuth: []

paths:
  /stores/{storeId}/competitors:
    parameters:
      - name: storeId
        in: path
        required: true
        description: 競合店舗を紐づける自店舗の ID
        schema:
          type: string
          format: uuid
    post:
      operationId: createCompetitor
      summary: Create Competitor
      description: |
        指定した自店舗に競合店舗を新規登録する。
        自店舗の所有権チェック（userId 一致）を行い、不一致の場合は 404 を返す。
      tags:
        - Competitors
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCompetitorRequest'
            examples:
              manual:
                summary: 手動登録
                value:
                  name: "ライバル店A"
                  longitude: 139.7671
                  latitude: 35.6812
                  source: "manual"
                  category: "コンビニ"
              googlePlaces:
                summary: Google Places から登録
                value:
                  name: "ライバル店B"
                  longitude: 139.7690
                  latitude: 35.6820
                  source: "google_places"
                  googlePlaceId: "ChIJN1t_tDeuEmsRUsoyG83frY4"
                  category: "スーパーマーケット"
      responses:
        '201':
          description: 競合店舗の作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompetitorResponse'
              examples:
                success:
                  summary: 作成成功
                  value:
                    id: "660e8400-e29b-41d4-a716-446655440001"
                    storeId: "550e8400-e29b-41d4-a716-446655440000"
                    name: "ライバル店A"
                    longitude: 139.7671
                    latitude: 35.6812
                    source: "manual"
                    googlePlaceId: null
                    category: "コンビニ"
                    createdAt: "2026-02-15T12:00:00.000Z"
                    updatedAt: "2026-02-15T12:00:00.000Z"
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidName:
                  summary: 名前が不正
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Name must be at least 1 character"
                invalidSource:
                  summary: source が不正
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Source must be \"manual\" or \"google_places\""
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: 未認証
                  value:
                    code: "UNAUTHORIZED"
                    message: "Authentication required"
        '404':
          description: 店舗が見つからない（所有権なしを含む）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notFound:
                  summary: 店舗が見つからない
                  value:
                    code: "NOT_FOUND"
                    message: "Store not found"
    get:
      operationId: listCompetitorsByStore
      summary: List Competitors by Store
      description: |
        指定した自店舗に紐づく競合店舗の一覧を取得する。
        自店舗の所有権チェックを行い、不一致の場合は 404 を返す。
      tags:
        - Competitors
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 競合店舗一覧の取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompetitorsResponse'
              examples:
                success:
                  summary: 一覧取得成功
                  value:
                    competitors:
                      - id: "660e8400-e29b-41d4-a716-446655440001"
                        storeId: "550e8400-e29b-41d4-a716-446655440000"
                        name: "ライバル店A"
                        longitude: 139.7671
                        latitude: 35.6812
                        source: "manual"
                        googlePlaceId: null
                        category: "コンビニ"
                        createdAt: "2026-02-15T12:00:00.000Z"
                        updatedAt: "2026-02-15T12:00:00.000Z"
                    total: 1
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 店舗が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /stores/{storeId}/competitors/search:
    parameters:
      - name: storeId
        in: path
        required: true
        description: 検索の中心点となる自店舗の ID
        schema:
          type: string
          format: uuid
    post:
      operationId: searchCompetitors
      summary: Search Nearby Competitors
      description: |
        自店舗の位置情報を基準に、指定した半径・キーワードで周辺の競合店舗を
        Google Places API（または Mock）で検索する。
        結果はプレビュー用であり、この時点ではデータベースに保存されない。
      tags:
        - CompetitorSearch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchCompetitorsRequest'
            examples:
              basic:
                summary: 基本検索
                value:
                  radiusMeters: 1000
                  keyword: "コンビニ"
              wideRange:
                summary: 広範囲検索
                value:
                  radiusMeters: 5000
                  keyword: "スーパーマーケット"
                  maxResults: 30
      responses:
        '200':
          description: 検索結果（プレビュー）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchCompetitorsResponse'
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 店舗が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: レート制限超過
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: 外部サービス利用不可
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /stores/{storeId}/competitors/bulk:
    parameters:
      - name: storeId
        in: path
        required: true
        description: 競合店舗を紐づける自店舗の ID
        schema:
          type: string
          format: uuid
    post:
      operationId: bulkCreateCompetitors
      summary: Bulk Create Competitors
      description: |
        検索結果から選択された競合店舗を一括登録する。
        既に同じ googlePlaceId で登録済みの場合はスキップし、新規のみ作成する。
        source は自動的に "google_places" に設定される。
      tags:
        - CompetitorSearch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkCreateCompetitorsRequest'
            examples:
              basic:
                summary: 3件一括登録
                value:
                  competitors:
                    - name: "セブンイレブン 東京駅前店"
                      longitude: 139.7671
                      latitude: 35.6812
                      googlePlaceId: "ChIJN1t_tDeuEmsRUsoyG83frY4"
                      category: "コンビニ"
                    - name: "ファミリーマート 丸の内店"
                      longitude: 139.7690
                      latitude: 35.6820
                      googlePlaceId: "ChIJe7wRAHuLGGARkFYMDqhIEZY"
                      category: "コンビニ"
                    - name: "ローソン 八重洲店"
                      longitude: 139.7710
                      latitude: 35.6805
                      googlePlaceId: "ChIJZ2b5KDeLGGARxvWYpTa7FQo"
                      category: "コンビニ"
      responses:
        '201':
          description: 一括登録結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkCreateCompetitorsResponse'
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 店舗が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /competitors/{competitorId}:
    parameters:
      - name: competitorId
        in: path
        required: true
        description: 競合店舗の ID
        schema:
          type: string
          format: uuid
    get:
      operationId: getCompetitor
      summary: Get Competitor
      description: |
        競合店舗を個別取得する。
        競合店舗の storeId を経由して所有権チェックを行い、不一致の場合は 404 を返す。
      tags:
        - Competitors
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 競合店舗の取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompetitorResponse'
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 競合店舗が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      operationId: updateCompetitor
      summary: Update Competitor
      description: |
        競合店舗を部分更新する。name, location (lng/lat), category の任意の組み合わせを更新可能。
        座標は longitude と latitude をペアで指定する必要がある。
        source と googlePlaceId は不変。
      tags:
        - Competitors
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCompetitorRequest'
            examples:
              nameOnly:
                summary: 名前のみ更新
                value:
                  name: "ライバル店A（改名）"
              locationAndCategory:
                summary: 座標とカテゴリを更新
                value:
                  longitude: 139.7680
                  latitude: 35.6815
                  category: "ドラッグストア"
      responses:
        '200':
          description: 競合店舗の更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompetitorResponse'
        '400':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingLatitude:
                  summary: 座標ペア不足
                  value:
                    code: "VALIDATION_ERROR"
                    message: "Both longitude and latitude must be provided together"
                emptyBody:
                  summary: 更新フィールドなし
                  value:
                    code: "VALIDATION_ERROR"
                    message: "At least one field must be provided"
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 競合店舗が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      operationId: deleteCompetitor
      summary: Delete Competitor
      description: |
        競合店舗を削除する。
        競合店舗の storeId を経由して所有権チェックを行い、不一致の場合は 404 を返す。
      tags:
        - Competitors
      security:
        - bearerAuth: []
      responses:
        '204':
          description: 競合店舗の削除成功（レスポンスボディなし）
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 競合店舗が見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT アクセストークン

  schemas:
    CreateCompetitorRequest:
      type: object
      required:
        - name
        - longitude
        - latitude
        - source
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: 競合店舗名（1〜100文字）
          example: "ライバル店A"
        longitude:
          type: number
          minimum: -180
          maximum: 180
          description: 経度（-180〜180）
          example: 139.7671
        latitude:
          type: number
          minimum: -90
          maximum: 90
          description: 緯度（-90〜90）
          example: 35.6812
        source:
          type: string
          enum:
            - manual
            - google_places
          description: 登録経路（手動登録 or Google Places）
          example: "manual"
        googlePlaceId:
          type: string
          maxLength: 200
          description: Google Places API の Place ID（source が google_places の場合）
          example: "ChIJN1t_tDeuEmsRUsoyG83frY4"
        category:
          type: string
          maxLength: 100
          description: 競合店舗のカテゴリ（任意）
          example: "コンビニ"

    UpdateCompetitorRequest:
      type: object
      description: |
        少なくとも 1 つのフィールドが必要。
        座標（longitude / latitude）はペアで指定する必要がある。
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: 競合店舗名（1〜100文字）
        longitude:
          type: number
          minimum: -180
          maximum: 180
          description: 経度（latitude とペアで指定）
        latitude:
          type: number
          minimum: -90
          maximum: 90
          description: 緯度（longitude とペアで指定）
        category:
          type: string
          maxLength: 100
          nullable: true
          description: 競合店舗のカテゴリ（null で削除可能）

    CompetitorResponse:
      type: object
      required:
        - id
        - storeId
        - name
        - longitude
        - latitude
        - source
        - googlePlaceId
        - category
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          format: uuid
          description: 競合店舗 ID
          example: "660e8400-e29b-41d4-a716-446655440001"
        storeId:
          type: string
          format: uuid
          description: 紐づく自店舗 ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          description: 競合店舗名
          example: "ライバル店A"
        longitude:
          type: number
          description: 経度
          example: 139.7671
        latitude:
          type: number
          description: 緯度
          example: 35.6812
        source:
          type: string
          enum:
            - manual
            - google_places
          description: 登録経路
          example: "manual"
        googlePlaceId:
          type: string
          nullable: true
          description: Google Places API の Place ID
          example: null
        category:
          type: string
          nullable: true
          description: 競合店舗のカテゴリ
          example: "コンビニ"
        createdAt:
          type: string
          format: date-time
          description: 作成日時（ISO 8601 形式）
          example: "2026-02-15T12:00:00.000Z"
        updatedAt:
          type: string
          format: date-time
          description: 更新日時（ISO 8601 形式）
          example: "2026-02-15T12:00:00.000Z"

    CompetitorsResponse:
      type: object
      required:
        - competitors
        - total
      properties:
        competitors:
          type: array
          items:
            $ref: '#/components/schemas/CompetitorResponse'
          description: 競合店舗のリスト
        total:
          type: integer
          minimum: 0
          description: 競合店舗の総数
          example: 5

    SearchCompetitorsRequest:
      type: object
      required:
        - radiusMeters
        - keyword
      properties:
        radiusMeters:
          type: integer
          minimum: 100
          maximum: 50000
          description: 検索半径（メートル、100〜50,000）
          example: 1000
        keyword:
          type: string
          minLength: 1
          maxLength: 100
          description: 検索キーワード（業種・店名など）
          example: "コンビニ"
        maxResults:
          type: integer
          minimum: 1
          maximum: 60
          default: 20
          description: 最大取得件数（1〜60、デフォルト 20）
          example: 20

    SearchCompetitorItem:
      type: object
      required:
        - name
        - longitude
        - latitude
        - googlePlaceId
        - category
        - address
      properties:
        name:
          type: string
          description: 店舗名
          example: "セブンイレブン 東京駅前店"
        longitude:
          type: number
          description: 経度
          example: 139.7671
        latitude:
          type: number
          description: 緯度
          example: 35.6812
        googlePlaceId:
          type: string
          description: Google Places の Place ID
          example: "ChIJN1t_tDeuEmsRUsoyG83frY4"
        category:
          type: string
          description: Google Places のカテゴリ
          example: "コンビニ"
        address:
          type: string
          description: 住所
          example: "東京都千代田区丸の内1-9-1"
        distanceMeters:
          type: number
          description: 自店舗からの距離（メートル）
          example: 350.5
        alreadyRegistered:
          type: boolean
          description: 既に競合として登録済みかどうか
          example: false

    SearchCompetitorsResponse:
      type: object
      required:
        - results
        - total
        - searchCenter
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchCompetitorItem'
        total:
          type: integer
          description: 検索結果の総数
          example: 15
        searchCenter:
          type: object
          required:
            - longitude
            - latitude
          properties:
            longitude:
              type: number
              example: 139.7670
            latitude:
              type: number
              example: 35.6810
          description: 検索の中心点（自店舗の位置）

    BulkCreateCompetitorItem:
      type: object
      required:
        - name
        - longitude
        - latitude
        - googlePlaceId
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: 競合店舗名
        longitude:
          type: number
          minimum: -180
          maximum: 180
          description: 経度
        latitude:
          type: number
          minimum: -90
          maximum: 90
          description: 緯度
        googlePlaceId:
          type: string
          maxLength: 200
          description: Google Places の Place ID
        category:
          type: string
          maxLength: 100
          description: カテゴリ（任意）

    BulkCreateCompetitorsRequest:
      type: object
      required:
        - competitors
      properties:
        competitors:
          type: array
          minItems: 1
          maxItems: 50
          items:
            $ref: '#/components/schemas/BulkCreateCompetitorItem'
          description: 登録する競合店舗のリスト（最大 50 件）

    BulkCreateCompetitorsResponse:
      type: object
      required:
        - created
        - skipped
        - total
      properties:
        created:
          type: array
          items:
            $ref: '#/components/schemas/CompetitorResponse'
          description: 新規作成された競合店舗
        skipped:
          type: array
          items:
            type: object
            required:
              - googlePlaceId
              - reason
            properties:
              googlePlaceId:
                type: string
              reason:
                type: string
                enum:
                  - already_registered
          description: スキップされた店舗（既に登録済み）
        total:
          type: object
          required:
            - created
            - skipped
          properties:
            created:
              type: integer
              example: 3
            skipped:
              type: integer
              example: 1

    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: エラーコード
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: エラーメッセージ
          example: "Name is required"
