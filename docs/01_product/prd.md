# Product Requirements Document (PRD)

## Overview

| 項目         | 内容                             |
| ------------ | -------------------------------- |
| プロダクト名 | Market Analyzer                  |
| バージョン   | 0.1.0（MVP）                     |
| 最終更新     | 2026-02-16                       |
| 担当         | Market Analyzer Development Team |

---

## Background / Problem Statement

<!-- なぜこのプロダクトが必要か -->

小売業の出店判断には、商圏の人口動態データと競合店の分布情報が不可欠である。
しかし、これらのデータは散在しており、統合的に分析するツールが不足している。

具体的には：

- 商圏の人口・世帯数・年齢分布・平均所得などのデータが複数のソースに分散
- 競合店の位置・カテゴリ情報を手動で収集・管理する手間が大きい
- 地理空間データを直感的に可視化・分析できるツールが少ない

Market Analyzer は、これらのデータを地図ベースで一元管理し、データドリブンな出店判断を支援する。

---

## Goals

<!-- このプロダクトで達成したいこと -->

### In Scope

- ユーザー認証（登録・ログイン・ログアウト・パスワードリセット）
- 自店舗の CRUD 管理（位置情報・住所付き）
- 競合店の CRUD 管理（手動登録 / Google Places 対応）
- 商圏分析（半径ベースの円形エリア定義 + 人口動態データ）
- 地図上での店舗・競合・商圏の可視化（Mapbox GL）
- プロフィール管理（名前変更・パスワード変更）

### Out of Scope

- リアルタイム売上データ連携
- POS システム統合
- 複数ユーザー間のコラボレーション機能
- Google Places API によるリアルタイム競合自動検出（将来実装予定）
- 多角形（ポリゴン）ベースの商圏定義
- 多言語対応

---

## User Stories

<!-- ユーザーストーリー形式で要件を記述 -->

| ID     | As a...          | I want to...                              | So that...                                         |
| ------ | ---------------- | ----------------------------------------- | -------------------------------------------------- |
| US-001 | 小売業者         | アカウントを作成してログインしたい         | 自分のデータを安全に管理できる                     |
| US-002 | 店舗展開担当者   | 自店舗を登録・編集・削除したい             | 自社の店舗網を正確に把握できる                     |
| US-003 | フランチャイジー | 競合店を登録・管理したい                   | 周辺の競合状況を一元的に把握できる                 |
| US-004 | 経営者           | 商圏を作成して人口動態データを分析したい   | 出店候補地のポテンシャルをデータで評価できる       |
| US-005 | 店舗展開担当者   | 地図上で店舗・競合・商圏を可視化したい     | 地理的な関係性を直感的に理解できる                 |
| US-006 | ユーザー         | プロフィール（名前・パスワード）を変更したい | アカウント情報を最新に保てる                       |

---

## Functional Requirements (FR)

<!-- 機能要件 -->

| ID     | 要件                                                                  | 優先度 | 関連 US |
| ------ | --------------------------------------------------------------------- | ------ | ------- |
| FR-001 | メールアドレスとパスワードでユーザー登録できる                        | Must   | US-001  |
| FR-002 | 登録済みメールアドレスとパスワードでログインできる                    | Must   | US-001  |
| FR-003 | ログアウトしてセッションを無効化できる                                | Must   | US-001  |
| FR-004 | アクセストークンをリフレッシュトークンで更新できる                    | Must   | US-001  |
| FR-005 | パスワードリセットをメール経由で実行できる                            | Should | US-001  |
| FR-006 | 店舗を名前・住所・座標付きで作成できる                                | Must   | US-002  |
| FR-007 | 自分の店舗一覧を取得できる                                            | Must   | US-002  |
| FR-008 | 店舗の名前・住所・座標を更新できる（楽観ロック付き）                  | Must   | US-002  |
| FR-009 | 店舗を削除できる（関連する競合店も連鎖削除）                          | Must   | US-002  |
| FR-010 | 店舗に紐づく競合店を名前・座標・カテゴリ付きで登録できる              | Must   | US-003  |
| FR-011 | 店舗ごとの競合店一覧を取得できる                                      | Must   | US-003  |
| FR-012 | 競合店の名前・座標・カテゴリを更新できる（楽観ロック付き）            | Must   | US-003  |
| FR-013 | 競合店を削除できる                                                    | Must   | US-003  |
| FR-014 | 中心座標と半径（0.1〜50km）で商圏を作成できる                        | Must   | US-004  |
| FR-015 | 商圏の人口動態データ（人口・世帯数・年齢分布・平均所得）を取得できる  | Must   | US-004  |
| FR-016 | 地図上に店舗・競合・商圏を表示できる                                  | Must   | US-005  |
| FR-017 | ユーザー名を変更できる                                                | Should | US-006  |
| FR-018 | パスワードを変更できる（全セッション無効化付き）                      | Should | US-006  |
| FR-019 | ヘルスチェックエンドポイント（DB 接続確認付き）を提供する             | Must   | -       |

---

## Non-Functional Requirements (NFR)

<!-- 非機能要件 -->

| 観点            | 要件                                                                                                             |
| --------------- | ---------------------------------------------------------------------------------------------------------------- |
| Performance     | API 応答 p95 < 500ms（認証）、p95 < 300ms（CRUD）、p95 < 200ms（一覧取得）。地図初期ロード < 3s、描画 60fps 目標 |
| Security        | JWT RS256（アクセス 15 分 / リフレッシュ 7 日）、bcrypt cost≥12、Zod 入力検証、PII 非ログ、所有権チェック        |
| Availability    | Docker ベースデプロイ、ヘルスチェックエンドポイント、99.9% 稼働率目標                                            |
| Scalability     | Clean Architecture による水平拡張可能な設計、ステートレス JWT 認証                                                |
| Maintainability | TypeScript strict モード、80%+ テストカバレッジ目標、CI/CD パイプライン、構造化ログ                               |

---

## Success Metrics

<!-- 成功指標 -->

| 指標                       | 目標値                       | 測定方法                             |
| -------------------------- | ---------------------------- | ------------------------------------ |
| API レスポンスタイム (p95) | CRUD < 300ms、一覧 < 200ms  | APM / ログ集計                       |
| テストカバレッジ           | 80% 以上                     | Vitest coverage レポート             |
| 型安全性                   | TypeScript strict エラー 0   | `./tools/contract typecheck`         |
| セキュリティ脆弱性         | Critical / High = 0          | `pnpm audit`                         |
| 登録→分析完了フロー       | 5 分以内に初回商圏分析完了   | ユーザーテスト                       |

---

## Dependencies

<!-- 依存関係 -->

- **PostgreSQL**: メインデータベース（Prisma ORM 経由）
- **Mapbox GL JS**: 地図描画エンジン（API キー必要）
- **Node.js 24+**: サーバーランタイム
- **Docker / Docker Compose**: 開発・デプロイ環境
- **Traefik**: Same-Origin リバースプロキシ
- **Google Places API**（将来）: 競合店自動検出

---

## Risks

<!-- リスクと対策 -->

| リスク                             | 影響 | 確率 | 対策                                             |
| ---------------------------------- | ---- | ---- | ------------------------------------------------ |
| 人口動態データがモック段階         | 高   | 確定 | 段階的にリアルデータソースに置換する設計          |
| Mapbox API の利用制限・料金変更    | 中   | 低   | 抽象化レイヤーで地図プロバイダを差し替え可能に    |
| Google Places API 連携の複雑さ     | 中   | 中   | MVP ではマニュアル登録を優先、API は Phase 2 で   |
| JWT アクセストークン即時無効化不可 | 低   | 低   | 有効期限 15 分で影響を限定、重要操作時は再認証    |

---

## Timeline

<!-- マイルストーン -->

| Phase   | 内容                                                 | 状態       |
| ------- | ---------------------------------------------------- | ---------- |
| Phase 1 | 認証基盤（登録・ログイン・JWT・パスワードリセット）  | 完了       |
| Phase 2 | 店舗管理 CRUD + プロフィール編集                     | 完了       |
| Phase 3 | 商圏分析（CRUD + モック人口動態 + 地図 UI）          | 完了       |
| Phase 4 | 競合店管理 CRUD                                      | 完了       |
| Phase 5 | フロントエンド統合（店舗・競合の地図 UI）             | 進行中     |
| Phase 6 | リアル人口動態データ連携 + Google Places 統合         | 未着手     |

---

## References

- [docs/01_product/identity.md](identity.md) - Product Identity
- [docs/01_product/glossary.md](glossary.md) - 用語集
- [docs/02_architecture/adr/](../02_architecture/adr/) - Architecture Decision Records
