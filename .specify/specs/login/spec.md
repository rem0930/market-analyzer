# Spec: ログイン機能

## Overview

メールアドレスとパスワードによるユーザー認証機能を提供する。JWT トークンベースのセッション管理を採用し、ユーザー登録・ログイン・ログアウト・パスワードリセットの一連の認証フローを実装する。

## Functional Requirements (FR)

### FR-001: ユーザー登録

新規ユーザーがメールアドレスとパスワードでアカウントを作成できる。

- メールアドレスの形式バリデーション
- パスワード強度の検証（8文字以上、英数字混合）
- メールアドレスの重複チェック
- パスワードのハッシュ化保存（bcrypt）

### FR-002: ログイン

登録済みユーザーがメールアドレスとパスワードで認証できる。

- 認証成功時に JWT アクセストークンとリフレッシュトークンを発行
- 認証失敗時に適切なエラーメッセージを返却
- ブルートフォース対策（レートリミット）

### FR-003: ログアウト

認証済みユーザーがセッションを終了できる。

- クライアント側のトークン削除
- リフレッシュトークンの無効化（サーバー側）

### FR-004: パスワードリセット

ユーザーがパスワードを忘れた場合にリセットできる。

- リセット用ワンタイムトークンをメール送信
- トークンの有効期限（1時間）
- 新パスワード設定後、既存セッションを無効化

### FR-005: トークンリフレッシュ

アクセストークンの有効期限切れ時にリフレッシュできる。

- リフレッシュトークンを使用して新しいアクセストークンを取得
- リフレッシュトークンのローテーション

## Non-Functional Requirements (NFR)

### NFR-001: Performance

- ログイン API のレスポンスタイム: 95%ile < 500ms
- 同時ログインリクエスト: 100 req/s 以上

### NFR-002: Security

- パスワードは bcrypt (cost factor 12) でハッシュ化
- JWT 署名アルゴリズム: RS256
- アクセストークン有効期限: 15分
- リフレッシュトークン有効期限: 7日
- HTTPS 必須
- CSRF 対策（SameSite Cookie）
- レートリミット: 同一 IP から 5回/分（ログイン試行）

### NFR-003: Availability

- 認証サービスの可用性: 99.9%

### NFR-004: Audit

- 認証イベントのログ記録（成功/失敗、IP、タイムスタンプ）

## Acceptance Criteria (AC)

### AC-001: ユーザー登録成功

**Given** 未登録のメールアドレスを持つユーザー
**When** 有効なメールアドレスとパスワードで登録リクエストを送信
**Then** ユーザーアカウントが作成され、201 レスポンスが返る

### AC-002: ユーザー登録失敗（重複メール）

**Given** 既に登録済みのメールアドレス
**When** 同じメールアドレスで登録リクエストを送信
**Then** 409 Conflict エラーが返る

### AC-003: ユーザー登録失敗（弱いパスワード）

**Given** パスワードが要件を満たさない（8文字未満など）
**When** 登録リクエストを送信
**Then** 400 Bad Request エラーとバリデーションメッセージが返る

### AC-004: ログイン成功

**Given** 登録済みユーザー
**When** 正しいメールアドレスとパスワードでログイン
**Then** JWT アクセストークンとリフレッシュトークンが返る

### AC-005: ログイン失敗（認証エラー）

**Given** 登録済みユーザー
**When** 誤ったパスワードでログイン
**Then** 401 Unauthorized エラーが返る（詳細な理由は開示しない）

### AC-006: ログアウト成功

**Given** 認証済みユーザー
**When** ログアウトリクエストを送信
**Then** リフレッシュトークンが無効化され、204 レスポンスが返る

### AC-007: パスワードリセット要求

**Given** 登録済みユーザー
**When** パスワードリセットを要求
**Then** リセット用リンクがメール送信される

### AC-008: パスワードリセット完了

**Given** 有効なリセットトークン
**When** 新しいパスワードを設定
**Then** パスワードが更新され、既存セッションが無効化される

### AC-009: トークンリフレッシュ成功

**Given** 有効なリフレッシュトークン
**When** トークンリフレッシュをリクエスト
**Then** 新しいアクセストークンとリフレッシュトークンが返る

### AC-010: レートリミット適用

**Given** 同一 IP からの連続ログイン試行
**When** 5回/分を超えてログイン試行
**Then** 429 Too Many Requests エラーが返る

## Out of Scope

- 多要素認証（MFA）
- OAuth / ソーシャルログイン
- アカウント削除
- メールアドレス変更
- セッション一覧表示・管理

## Assumptions

- メール送信基盤は別途用意される（本 Spec ではインターフェースのみ定義）
- データベースは PostgreSQL を使用
- フロントエンドは React SPA を想定
