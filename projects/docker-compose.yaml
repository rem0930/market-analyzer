# Docker Compose for Development
# Auto-generated by stack: node-ts_pnpm
# Run: ./tools/contract dev

version: '3.8'

services:
  # API service
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.dev
    container_name: monorepo-api
    ports:
      - '3000:3000' # Application port
      - '9229:9229' # Node.js debug port
    volumes:
      # Mount source code for hot reload
      - ./apps/api/src:/app/src:cached
      - ./packages:/packages:cached
      # Named volume for node_modules (performance)
      - api_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - DEBUG_PORT=9229
    # Health check
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Restart policy
    restart: unless-stopped
    # Network
    networks:
      - app-network

  # Add more services as needed:
  # web:
  #   build:
  #     context: ./apps/web
  #     dockerfile: Dockerfile.dev
  #   ports:
  #     - "5173:5173"
  #   volumes:
  #     - ./apps/web/src:/app/src:cached
  #   depends_on:
  #     - api
  #   networks:
  #     - app-network

  # Database service (optional, uncomment if needed)
  # db:
  #   image: postgres:16-alpine
  #   container_name: monorepo-db
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     POSTGRES_USER: devuser
  #     POSTGRES_PASSWORD: devpass
  #     POSTGRES_DB: devdb
  #   volumes:
  #     - db_data:/var/lib/postgresql/data
  #   networks:
  #     - app-network

volumes:
  api_node_modules:
  # db_data:

networks:
  app-network:
    driver: bridge
