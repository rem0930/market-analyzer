openapi: 3.0.3
info:
  title: Monorepo API
  description: |
    API specification for the monorepo.
    This is the single source of truth for API types.
  version: 0.0.1
  contact:
    name: API Team

servers:
  - url: http://localhost:3001
    description: Local development

paths:
  /health:
    get:
      operationId: getHealth
      summary: Health check endpoint
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /users:
    get:
      operationId: getUsers
      summary: Get all users
      tags:
        - Users
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UsersResponse'
    post:
      operationId: createUser
      summary: Create a new user
      tags:
        - Users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # Authentication Endpoints
  # ============================================
  /auth/register:
    post:
      operationId: register
      summary: Register a new user
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUser'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      operationId: login
      summary: Login with email and password
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Too many login attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      operationId: logout
      summary: Logout and invalidate refresh token
      tags:
        - Auth
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Logged out successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      operationId: refreshToken
      summary: Refresh access token
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/forgot-password:
    post:
      operationId: forgotPassword
      summary: Request password reset email
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ForgotPasswordRequest'
      responses:
        '200':
          description: Password reset email sent (always returns 200 for security)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'

  /auth/reset-password:
    post:
      operationId: resetPassword
      summary: Reset password with token
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResetPasswordRequest'
      responses:
        '200':
          description: Password reset successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      operationId: getCurrentUser
      summary: Get current authenticated user
      tags:
        - Auth
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUser'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # Profile Endpoints
  # ============================================
  /users/me/name:
    patch:
      operationId: updateMyName
      summary: Update current user's name
      tags:
        - Profile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateNameRequest'
      responses:
        '200':
          description: Name updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/me/password:
    patch:
      operationId: updateMyPassword
      summary: Update current user's password
      tags:
        - Profile
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePasswordRequest'
      responses:
        '200':
          description: Password updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Validation error or current password incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # Trade Area Endpoints
  # ============================================
  /trade-areas:
    post:
      operationId: createTradeArea
      summary: Create a new trade area
      tags:
        - TradeAreas
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTradeAreaRequest'
      responses:
        '201':
          description: Trade area created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TradeAreaResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      operationId: listTradeAreas
      summary: List trade areas for current user
      tags:
        - TradeAreas
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of trade areas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TradeAreasResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /trade-areas/{tradeAreaId}:
    get:
      operationId: getTradeArea
      summary: Get a trade area by ID
      tags:
        - TradeAreas
      security:
        - BearerAuth: []
      parameters:
        - name: tradeAreaId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Trade area found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TradeAreaResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Trade area not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      operationId: updateTradeArea
      summary: Update a trade area
      tags:
        - TradeAreas
      security:
        - BearerAuth: []
      parameters:
        - name: tradeAreaId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTradeAreaRequest'
      responses:
        '200':
          description: Trade area updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TradeAreaResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Trade area not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      operationId: deleteTradeArea
      summary: Delete a trade area
      tags:
        - TradeAreas
      security:
        - BearerAuth: []
      parameters:
        - name: tradeAreaId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Trade area deleted successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Trade area not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /trade-areas/{tradeAreaId}/demographics:
    get:
      operationId: getTradeAreaDemographics
      summary: Get demographic data for a trade area
      tags:
        - TradeAreas
      security:
        - BearerAuth: []
      parameters:
        - name: tradeAreaId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Demographic data for the trade area
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DemographicDataResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Trade area not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # Store Endpoints
  # ============================================
  /stores:
    post:
      operationId: createStore
      summary: Create a new store
      tags:
        - Stores
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoreRequest'
      responses:
        '201':
          description: Store created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      operationId: listStores
      summary: List stores for current user
      tags:
        - Stores
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of stores
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoresResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /stores/{storeId}:
    get:
      operationId: getStore
      summary: Get a store by ID
      tags:
        - Stores
      security:
        - BearerAuth: []
      parameters:
        - name: storeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Store found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      operationId: updateStore
      summary: Update a store
      tags:
        - Stores
      security:
        - BearerAuth: []
      parameters:
        - name: storeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStoreRequest'
      responses:
        '200':
          description: Store updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      operationId: deleteStore
      summary: Delete a store
      tags:
        - Stores
      security:
        - BearerAuth: []
      parameters:
        - name: storeId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Store deleted successfully
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Store not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ============================================
  # User Endpoints
  # ============================================
  /users/{userId}:
    get:
      operationId: getUserById
      summary: Get user by ID
      tags:
        - Users
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
        timestamp:
          type: string
          format: date-time

    User:
      type: object
      required:
        - id
        - name
        - email
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          minLength: 1
          maxLength: 100
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateUserRequest:
      type: object
      required:
        - name
        - email
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        email:
          type: string
          format: email

    UsersResponse:
      type: object
      required:
        - users
        - total
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'
        total:
          type: integer
          minimum: 0

    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

    # ============================================
    # Auth Schemas
    # ============================================
    RegisterRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
          maxLength: 128
          description: Must contain at least one letter and one number

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    TokenResponse:
      type: object
      required:
        - accessToken
        - expiresIn
        - tokenType
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
          description: Only returned on login, not on refresh
        expiresIn:
          type: integer
          description: Access token expiration time in seconds
        tokenType:
          type: string
          enum: [Bearer]

    RefreshTokenRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string

    ForgotPasswordRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email

    ResetPasswordRequest:
      type: object
      required:
        - token
        - password
      properties:
        token:
          type: string
        password:
          type: string
          minLength: 8
          maxLength: 128

    AuthUser:
      type: object
      required:
        - id
        - email
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    MessageResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string

    # ============================================
    # Trade Area Schemas
    # ============================================
    GeoPoint:
      type: object
      required:
        - longitude
        - latitude
      properties:
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90

    CreateTradeAreaRequest:
      type: object
      required:
        - name
        - longitude
        - latitude
        - radiusKm
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
        radiusKm:
          type: number
          format: double
          minimum: 0.1
          maximum: 50

    UpdateTradeAreaRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90
        radiusKm:
          type: number
          format: double
          minimum: 0.1
          maximum: 50

    TradeAreaResponse:
      type: object
      required:
        - id
        - userId
        - name
        - longitude
        - latitude
        - radiusKm
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        name:
          type: string
        longitude:
          type: number
          format: double
        latitude:
          type: number
          format: double
        radiusKm:
          type: number
          format: double
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    TradeAreasResponse:
      type: object
      required:
        - tradeAreas
        - total
      properties:
        tradeAreas:
          type: array
          items:
            $ref: '#/components/schemas/TradeAreaResponse'
        total:
          type: integer
          minimum: 0

    AgeDistribution:
      type: object
      required:
        - range
        - count
        - percentage
      properties:
        range:
          type: string
          description: 'Age range label (e.g., "0-14", "15-24")'
        count:
          type: integer
          minimum: 0
        percentage:
          type: number
          format: double
          minimum: 0
          maximum: 100

    DemographicDataResponse:
      type: object
      required:
        - tradeAreaId
        - population
        - households
        - averageIncome
        - ageDistribution
      properties:
        tradeAreaId:
          type: string
          format: uuid
        population:
          type: integer
          minimum: 0
        households:
          type: integer
          minimum: 0
        averageIncome:
          type: integer
          minimum: 0
          description: Average annual income in JPY
        ageDistribution:
          type: array
          items:
            $ref: '#/components/schemas/AgeDistribution'

    # ============================================
    # Store Schemas
    # ============================================
    CreateStoreRequest:
      type: object
      required:
        - name
        - address
        - longitude
        - latitude
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        address:
          type: string
          minLength: 1
          maxLength: 500
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90

    UpdateStoreRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        address:
          type: string
          minLength: 1
          maxLength: 500
        longitude:
          type: number
          format: double
          minimum: -180
          maximum: 180
        latitude:
          type: number
          format: double
          minimum: -90
          maximum: 90

    StoreResponse:
      type: object
      required:
        - id
        - userId
        - name
        - address
        - longitude
        - latitude
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        name:
          type: string
        address:
          type: string
        longitude:
          type: number
          format: double
        latitude:
          type: number
          format: double
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    StoresResponse:
      type: object
      required:
        - stores
        - total
      properties:
        stores:
          type: array
          items:
            $ref: '#/components/schemas/StoreResponse'
        total:
          type: integer
          minimum: 0

    # ============================================
    # Profile Schemas
    # ============================================
    UpdateNameRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100

    UpdatePasswordRequest:
      type: object
      required:
        - currentPassword
        - newPassword
      properties:
        currentPassword:
          type: string
        newPassword:
          type: string
          minLength: 8
          maxLength: 128
          description: Must contain at least one letter and one number

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
