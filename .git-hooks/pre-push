#!/usr/bin/env bash
# .git-hooks/pre-push
# mainブランチへの直接プッシュを防止する

set -euo pipefail

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Protected branches
PROTECTED_BRANCHES=("main" "master" "develop")

# Read the push information
while read -r local_ref local_sha remote_ref remote_sha; do
    # Extract branch name from remote ref
    if [[ "$remote_ref" =~ refs/heads/(.+)$ ]]; then
        push_branch="${BASH_REMATCH[1]}"
        
        for protected in "${PROTECTED_BRANCHES[@]}"; do
            if [[ "$push_branch" == "$protected" ]]; then
                echo ""
                echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
                echo -e "${RED}║  ⛔ PUSH BLOCKED: Protected branch '${protected}'              ║${NC}"
                echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
                echo ""
                echo -e "${YELLOW}'${protected}' ブランチへの直接プッシュは禁止されています。${NC}"
                echo ""
                echo "Pull Request を作成してマージしてください:"
                echo ""
                echo "  1. 作業ブランチをプッシュ:"
                echo "     git push origin your-feature-branch"
                echo ""
                echo "  2. Pull Request を作成:"
                echo "     gh pr create --base main --head your-feature-branch"
                echo ""
                exit 1
            fi
        done
    fi
done

exit 0
